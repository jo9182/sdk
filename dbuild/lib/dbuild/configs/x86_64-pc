source "${DBUILD_LIB_DIR}/configs/common"

TARGET_MACHINE=x86_64
QEMU_CMD="qemu-system-x86_64"
PACKAGES+=(grub grub-x86_64-efi syslinux)
DISK_IMAGES=("efiboot vfat /boot/efi defaults")
GRUB_MODULES=(boot linux ext2 fat squash4 part_msdos part_gpt normal configfile search memdisk)
KERNEL_CMDLINE="root=live:CDLABEL=EXPIDUS_LIVE rd.live.overlay.overlayfs=1"

post_build_live() {
	mkdir -p "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/grub/x86_64-efi/"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/grub/x86_64-efi/"* "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/grub/x86_64-efi/"
}

post_gen_fstab() {
	echo "# fstab generated by dbuild" >"${DBUILD_ROOTFS_DIR}/etc/fstab"
	echo "tmpfs /tmp tmpfs defaults,nosuid,nodev 0 0" >>"${DBUILD_ROOTFS_DIR}/etc/fstab"
}

pre_build_initramfs() {
	mkdir -p "${DBUILD_ROOTFS_DIR}/boot/grub/"
	mkdir -p "${DBUILD_ROOTFS_DIR}/boot/efi/EFI/BOOT"

	msg "Generating grub config"
	cat << EOF > "${DBUILD_ROOTFS_DIR}/boot/grub/grub.cfg"
set timeout=25
set default=0

menuentry "ExpidusOS ${EXPIDUS_VERSION}" {
	linux /boot/vmlinuz-${KERNEL_VERSION} ${KERNEL_CMDLINE}
	initrd /boot/initramfs-${KERNEL_VERSION}.img
	boot
}
EOF

	local tmp=$(mktemp)
	cat << EOF > "${tmp}"
insmod iso9660
insmod ext2
search --label --set root EXPIDUS_LIVE
configfile (\$root)/boot/grub/grub.cfg
EOF
	grub-mkstandalone -d "${DBUILD_ROOTFS_DIR}/usr/lib/grub/x86_64-efi" -O x86_64-efi --modules="iso9660 ext2 search configfile" -o "${DBUILD_ROOTFS_DIR}/boot/efi/EFI/BOOT/BOOTX64.EFI" "boot/grub/grub.cfg=${tmp}" || (rm "${tmp}"; exit 1)
	rm "${tmp}"
}

post_build_images() {
	cp "${DBUILD_BUILD_DIR}/efiboot-${EXPIDUS_VERSION}-${TARGET_ARCH}.img" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/grub/efiboot.img"
	mkdir -p "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/isolinux.bin" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/ldlinux.c32" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/libcom32.c32" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/vesamenu.c32" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/libutil.c32" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cp "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/chain.c32" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux"
	cat << EOF >"${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}/boot/isolinux/isolinux.cfg"
UI vesamenu.c32
PROMPT 0
TIMEOUT 100
ONTIMEOUT linux

MEMU TABMSG [RETURN]: boot [TAB]: edit menu entry
MENU AUTOBOOT BIOS default device boot in # second{,s}...
MENU WIDTH 78
MENU MARGIN 1
MENU ROWS 4
MENU VSHIFT 2
MENU TIMEOUTROW 8
MENU TABMSGROW 2
MENU CMDLINEROW 11
MENU HELPMSGROW 16
MENU HELPMSGENDROW 29

MENU COLOR title * #FF5255FF *
MENU COLOR border * #00000000 #00000000 none
MENU COLOR sel * #ffffffff #FF5255FF *

LABEL linux
MENU LABEL ExpidusOS 0.1.0-prealpha
KERNEL /boot/vmlinuz-${KERNEL_VERSION}
APPEND initrd=/boot/initramfs-${KERNEL_VERSION}.img ${KERNEL_CMDLINE}
EOF
	xorriso -as mkisofs -iso-level 3 -rock -joliet -max-iso9660-filenames -omit-period -omit-version-number -relaxed-filenames -allow-lowercase \
		-volid "EXPIDUS_LIVE" -eltorito-boot "boot/isolinux/isolinux.bin" -eltorito-catalog "boot/isolinux/boot.cat" -no-emul-boot \
		-boot-load-size 4 -boot-info-table -eltorito-alt-boot -e boot/grub/efiboot.img -isohybrid-gpt-basdat -no-emul-boot \
		-isohybrid-mbr "${DBUILD_ROOTFS_DIR}/usr/lib/syslinux/isohdpfx.bin" -output "${DBUILD_BUILD_DIR}/expidus-${EXPIDUS_VERSION}-${TARGET_ARCH}.iso" "${DBUILD_BUILD_DIR}/live-${EXPIDUS_VERSION}-${TARGET_ARCH}"
}
